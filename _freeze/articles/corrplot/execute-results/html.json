{
  "hash": "84d9aff64aa8e529dc0a56fee1fe7654",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"corrplot\"\nauthor: \"データサイエンス関連基礎調査WG\"\ndate: \"2025-08-01\"\nformat:\n  html:\n    toc: true\n    toc-depth: 4\n    fig-width: 6\n    fig-height: 5\n---\n\n\n\n\n\n\n\n\n## パッケージの概要\n\n`corrplot`は、相関行列の可視化に特化したパッケージです。\nデフォルトの設定でも相関行列を見やすい形で表示できるほか、\n50を超えるパラメータにより見た目を自由にカスタマイズできます。\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(corrplot) \nlibrary(Lahman) #今回使用するデータセット \nlibrary(data.table) #データの成形に使用\nlibrary(lsr) #相関行列以外の例に使用\n```\n:::\n\n\n\n\n## データセットの準備\n\n今回は公開されているデータセットでもカラム数の多い、'Sean Lahman's Baseball Database'というデータセットを使用します。\n\nこれはMLBの選手別・チーム別の成績等を蓄積したデータベースで、\n今回は選手情報が格納された`People`、各年度の打撃成績が格納された`Batting`、\n年俸が格納された`Salaries`の3つのテーブルを結合して使用します。\n\nデータセットの詳細については[パッケージ付属のDocumentation](https://search.r-project.org/CRAN/refmans/Lahman/html/Lahman-package.html)を参照してください。\n\nまず、上記テーブルの読み込み・結合と、最低限の前処理を行います。\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#大規模データの処理に向くdata.tableとしてデータを保持\ndt_mlb_people <- as.data.table(People)\ndt_mlb_batting <- as.data.table(Batting)\ndt_mlb_salaries <- as.data.table(Salaries)\n#People(選手情報)からは一部の列のみを取得\ndt_mlb_people <- dt_mlb_people[,.(playerID, birthCountry, birthState, weight, height, bats, throws, birthDate)]\n#Salaries(年俸)テーブルとBatting(打撃成績)をLeft join\ndt_mlb <- dt_mlb_batting[dt_mlb_salaries, on = .(yearID, teamID, lgID, playerID)]\n#上記テーブルとPeopleをLeft join\ndt_mlb <- dt_mlb_people[dt_mlb, on = .(playerID)]\n#文字列型となっている列などをfactor型に変換\ndt_mlb$playerID <- as.factor(dt_mlb$playerID)\ndt_mlb$birthCountry <- as.factor(dt_mlb$birthCountry)\ndt_mlb$birthState <- as.factor(dt_mlb$birthState)\ndt_mlb$stint <- as.factor(dt_mlb$stint)\n#日付型となっている列を数値型に変換\ndt_mlb$birthDate <- as.numeric(dt_mlb$birthDate)\n```\n:::\n\n\n\n\n出来上がったテーブルの概要は以下のとおり。\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#レコード数\nnrow(dt_mlb)\n## [1] 26437\n#列名リスト\nnames(dt_mlb)\n##  [1] \"playerID\"     \"birthCountry\" \"birthState\"   \"weight\"       \"height\"      \n##  [6] \"bats\"         \"throws\"       \"birthDate\"    \"yearID\"       \"stint\"       \n## [11] \"teamID\"       \"lgID\"         \"G\"            \"AB\"           \"R\"           \n## [16] \"H\"            \"X2B\"          \"X3B\"          \"HR\"           \"RBI\"         \n## [21] \"SB\"           \"CS\"           \"BB\"           \"SO\"           \"IBB\"         \n## [26] \"HBP\"          \"SH\"           \"SF\"           \"GIDP\"         \"salary\"\n#テーブル表示\ndt_mlb\n##         playerID birthCountry birthState weight height   bats throws birthDate\n##           <fctr>       <fctr>     <fctr>  <int>  <int> <fctr> <fctr>     <num>\n##     1: barkele01          USA         KY    225     77      R      R     -5292\n##     2: bedrost01          USA         MA    200     75      R      R     -4409\n##     3: benedbr01          USA         AL    175     73      R      R     -5250\n##     4:  campri01          USA         GA    195     73      R      R     -6049\n##     5: ceronri01          USA         NJ    192     71      R      R     -5706\n##    ---                                                                        \n## 26433: strasst01          USA         CA    239     77      R      R      6775\n## 26434: taylomi02          USA         FL    215     76      R      R      7754\n## 26435: treinbl01          USA         KS    225     77      R      R      6755\n## 26436: werthja01          USA         IL    235     77      R      R      3426\n## 26437: zimmery01          USA         NC    215     75      R      R      5384\n##        yearID  stint teamID   lgID     G    AB     R     H   X2B   X3B    HR\n##         <int> <fctr> <fctr> <fctr> <int> <int> <int> <int> <int> <int> <int>\n##     1:   1985      1    ATL     NL    20    17     0     0     0     0     0\n##     2:   1985      1    ATL     NL    37    64     3     5     0     0     0\n##     3:   1985      1    ATL     NL    70   208    12    42     6     0     0\n##     4:   1985      1    ATL     NL    66    13     1     3     0     0     1\n##     5:   1985      1    ATL     NL    96   282    15    61     9     0     3\n##    ---                                                                      \n## 26433:   2016      1    WAS     NL    24    48     3    10     1     0     0\n## 26434:   2016      1    WAS     NL    76   221    28    51    11     0     7\n## 26435:   2016      1    WAS     NL    73     0     0     0     0     0     0\n## 26436:   2016      1    WAS     NL   143   525    84   128    28     0    21\n## 26437:   2016      1    WAS     NL   115   427    60    93    18     1    15\n##          RBI    SB    CS    BB    SO   IBB   HBP    SH    SF  GIDP   salary\n##        <int> <int> <int> <int> <int> <int> <int> <int> <int> <int>    <int>\n##     1:     0     0     1     0     7     0     0     0     0     0   870000\n##     2:     1     0     0     1    22     0     0     6     0     0   550000\n##     3:    20     0     1    22    12     1     1     4     2     8   545000\n##     4:     2     0     0     1     5     0     0     1     0     0   633333\n##     5:    25     0     3    29    25     1     1     0     4    15   625000\n##    ---                                                                     \n## 26433:     2     0     0     2    11     0     0     7     0     2 10400000\n## 26434:    16    14     3    14    77     0     1     0     1     2   524000\n## 26435:     0     0     0     0     0     0     0     0     0     0   524900\n## 26436:    69     5     1    71   139     0     4     0     6    17 21733615\n## 26437:    46     4     1    29   104     1     5     0     6    12 14000000\n#サマリを表示\nsummary(dt_mlb)\n##       playerID        birthCountry     birthState        weight     \n##  moyerja01:   25   USA      :20505   CA     : 4872   Min.   :140.0  \n##  vizquom01:   24   D.R.     : 2140   TX     : 1551   1st Qu.:185.0  \n##  glavito02:   23   Venezuela: 1107   FL     : 1490   Median :195.0  \n##  bondsba01:   22   P.R.     :  892   NY     :  984   Mean   :199.2  \n##  griffke02:   22   Mexico   :  333   IL     :  963   3rd Qu.:215.0  \n##  rodrial01:   22   CAN      :  304   (Other):15534   Max.   :315.0  \n##  (Other)  :26299   (Other)  : 1156   NA's   : 1043                  \n##      height     bats      throws      birthDate            yearID    \n##  Min.   :66.0   B: 2579   B:    0   Min.   :-16407.0   Min.   :1985  \n##  1st Qu.:72.0   L: 7488   L: 5660   1st Qu.: -1918.0   1st Qu.:1994  \n##  Median :74.0   R:16370   R:20777   Median :   575.0   Median :2001  \n##  Mean   :73.5             S:    0   Mean   :   693.7   Mean   :2001  \n##  3rd Qu.:75.0                       3rd Qu.:  3426.0   3rd Qu.:2009  \n##  Max.   :83.0                       Max.   :  9168.0   Max.   :2016  \n##                                                                      \n##   stint           teamID      lgID             G                AB       \n##  1   :25263   LAN    :  958   AL:12962   Min.   :  1.00   Min.   :  0.0  \n##  2   :  163   CLE    :  950   NL:13475   1st Qu.: 29.00   1st Qu.:  1.0  \n##  3   :   14   PHI    :  949              Median : 56.00   Median : 63.0  \n##  4   :    1   BOS    :  945              Mean   : 67.84   Mean   :173.1  \n##  NA's:  996   SLN    :  943              3rd Qu.:107.00   3rd Qu.:331.0  \n##               BAL    :  940              Max.   :163.00   Max.   :716.0  \n##               (Other):20752              NA's   :996      NA's   :996    \n##        R                H               X2B              X3B         \n##  Min.   :  0.00   Min.   :  0.00   Min.   : 0.000   Min.   : 0.0000  \n##  1st Qu.:  0.00   1st Qu.:  0.00   1st Qu.: 0.000   1st Qu.: 0.0000  \n##  Median :  5.00   Median : 11.00   Median : 2.000   Median : 0.0000  \n##  Mean   : 23.35   Mean   : 45.64   Mean   : 8.816   Mean   : 0.9713  \n##  3rd Qu.: 41.00   3rd Qu.: 85.00   3rd Qu.:16.000   3rd Qu.: 1.0000  \n##  Max.   :152.00   Max.   :262.00   Max.   :59.000   Max.   :23.0000  \n##  NA's   :996      NA's   :996      NA's   :996      NA's   :996      \n##        HR              RBI               SB                CS        \n##  Min.   : 0.000   Min.   :  0.00   Min.   :  0.000   Min.   : 0.000  \n##  1st Qu.: 0.000   1st Qu.:  0.00   1st Qu.:  0.000   1st Qu.: 0.000  \n##  Median : 0.000   Median :  5.00   Median :  0.000   Median : 0.000  \n##  Mean   : 5.133   Mean   : 22.28   Mean   :  3.323   Mean   : 1.419  \n##  3rd Qu.: 7.000   3rd Qu.: 38.00   3rd Qu.:  3.000   3rd Qu.: 2.000  \n##  Max.   :73.000   Max.   :165.00   Max.   :110.000   Max.   :29.000  \n##  NA's   :996      NA's   :996      NA's   :996       NA's   :996     \n##        BB               SO             IBB               HBP        \n##  Min.   :  0.00   Min.   :  0.0   Min.   :  0.000   Min.   : 0.000  \n##  1st Qu.:  0.00   1st Qu.:  0.0   1st Qu.:  0.000   1st Qu.: 0.000  \n##  Median :  4.00   Median : 17.0   Median :  0.000   Median : 0.000  \n##  Mean   : 16.93   Mean   : 32.4   Mean   :  1.434   Mean   : 1.554  \n##  3rd Qu.: 28.00   3rd Qu.: 55.0   3rd Qu.:  1.000   3rd Qu.: 2.000  \n##  Max.   :232.00   Max.   :223.0   Max.   :120.000   Max.   :35.000  \n##  NA's   :996      NA's   :996     NA's   :996       NA's   :996     \n##        SH               SF              GIDP            salary        \n##  Min.   : 0.000   Min.   : 0.000   Min.   : 0.000   Min.   :       0  \n##  1st Qu.: 0.000   1st Qu.: 0.000   1st Qu.: 0.000   1st Qu.:  293750  \n##  Median : 0.000   Median : 0.000   Median : 1.000   Median :  550000  \n##  Mean   : 1.637   Mean   : 1.463   Mean   : 3.915   Mean   : 2085160  \n##  3rd Qu.: 2.000   3rd Qu.: 2.000   3rd Qu.: 7.000   3rd Qu.: 2350000  \n##  Max.   :39.000   Max.   :17.000   Max.   :35.000   Max.   :33000000  \n##  NA's   :996      NA's   :996      NA's   :996\n```\n:::\n\n\n\n\n## 使用例\n\n相関行列を計算するには数値型である必要があるため、factor型となっている特徴量は除いておきます。\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncols_factor <- names(dt_mlb)[sapply(dt_mlb, is.factor)]\ncols_nonfactor <- setdiff(names(dt_mlb), cols_factor)\ndt <- dt_mlb[,.SD,.SDcol = c(cols_nonfactor)]\n```\n:::\n\n\n\n\n`cor`関数で相関行列を計算し、`corrplot`関数を用いて相関行列を可視化します。\n\n`salary`との相関を確認してみると、打撃成績の中では`HR`(ホームラン)との相関が相対的に強いように見えます。\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmat_cor <- cor(dt, \n               method = 'pearson', #ピアソンの積率相関係数。順位相関係数(ケンドール、スピアマン)も使用できる。\n               use = 'pairwise.complete.obs')\n#NAとなっているデータの取り扱い。\n#デフォルトはNAが混ざっている列の相関係数をNAとするものであったので、\n#NAとなっているデータを無視して計算するように設定。\ncorrplot(mat_cor)\n```\n\n::: {.cell-output-display}\n![](corrplot_files/figure-html/corrplot1-1.png){width=576}\n:::\n:::\n\n\n\n\n以下、いくつか見た目のカスタマイズ例を紹介します。\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncorrplot(mat_cor[c(1:12,22), c(1:12,22)],\n         method = 'color', #単純な色分けのみにする\n         tl.cex = 0.75, #特徴量名のフォント大きさ調節(小さめ)\n         addCoef.col = 'black', #相関係数を指定した色で表示\n         number.cex = 0.65, #相関係数のフォント大きさ調節(小さめ)\n         order = 'AOE', #相関の高いもの同士が近くになるように表示順序を変更\n         col = adjustcolor(COL2('BrBG', 200),#色合いを変更 200は色の段階数\n                           offset = c(1/5, 1/5, 1/5, 0), #相関係数が見えやすいよう少し薄く色を調節\n                           transform = diag(c(4/5, 4/5, 4/5, 1))) \n         )\n```\n\n::: {.cell-output-display}\n![](corrplot_files/figure-html/corrplot2-1.png){width=576}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmat_p <- cor.mtest(dt, conf.level = 0.95)$p #p値の計算\ncorrplot(mat_cor[c(1:12,22), c(1:12,22)],\n         method = 'square', #正方形で表示\n         diag = FALSE, #対角線は表示しない\n         tl.pos = 'd', #特徴量名を対角線に表示\n         tl.cex = 0.6, #特徴量名のフォント大きさ調節(小さめ)\n         order = 'hclust', #相関の高いもの同士が近くになるように表示順序を変更\n         addrect = 3, #hclustを選択した時のみ指定可能、近いもの同士を3つに分類して正方形の枠で囲む\n         rect.col = 'gray40', #前述の枠の色\n         p.mat = mat_p[c(1:12,22), c(1:12,22)], #p値行列を与える\n         sig.level = 0.10, #p値が0.1以上であれば×を表示\n         )\n```\n\n::: {.cell-output-display}\n![](corrplot_files/figure-html/corrplot3-1.png){width=576}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmat_p = cor.mtest(dt, conf.level = 0.95)$p #p値の計算\ncorrplot(mat_cor[c(1:12,22), c(1:12,22)],\n         type = 'lower', #下半分のみ表示\n         method = 'shade', #単純な色分けだが、指定した条件を満たすの場合は斜め線を入れる\n         addshade = 'negative', #斜め線を入れる条件\n         tl.cex = 0.6, #特徴量名のフォント大きさ調節(小さめ)\n         order = 'alphabet', #名前順\n         p.mat = mat_p[c(1:12,22), c(1:12,22)], #p値行列を与える\n         insig ='label_sig', #p値に応じて*を入れる\n         sig.level = c(0.001, 0.01, 0.05), #*の数のしきい値\n         pch.cex = 0.9, #*の大きさ\n         )\n```\n\n::: {.cell-output-display}\n![](corrplot_files/figure-html/corrplot4-1.png){width=576}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncorrplot.mixed(mat_cor[c(1:12,22), c(1:12,22)], #corrplot.mixedとすると二つの表示形式をミックスできる\n         lower = 'number', #下半分は相関係数を表示する\n         upper = 'ellipse', #上半分は楕円で表示する\n         tl.cex = 0.6, #特徴量名のフォント大きさ調節(小さめ)\n         number.cex = 0.55, #相関係数のフォント大きさ調節(小さめ)\n         order = 'AOE', #相関の高いもの同士が近くになるように表示順序を変更\n         )\n```\n\n::: {.cell-output-display}\n![](corrplot_files/figure-html/corrplot5-1.png){width=576}\n:::\n:::\n\n\n\n\n相関行列ではないものを表示することも可能です。\n\n例えば、質的変数と量的変数の組に対して分散分析のイプシロンを表示してみます。\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmat_nf <- matrix(nrow = length(cols_nonfactor), ncol = length(cols_factor))\nrownames(mat_nf) <- cols_nonfactor\ncolnames(mat_nf) <- cols_factor\n\ndt <- dt_mlb\nfor(c_r in cols_nonfactor){\n  for(c_c in cols_factor){\n    dt_tmp <- dt[!is.na(dt[[c_r]]) & !is.na(dt[[c_c]]),.SD, .SDcols = c(c_r, c_c)]\n    mu <- mean(dt_tmp[[c_r]])\n    ss_t <- sum((dt_tmp[[c_r]]-mu)^2)\n    ss_m <- sum(dt_tmp[, .(ss = .N * (mean(.SD[[1]]) - ..mu)^2), by = c_c, .SDcols = c_r]$ss)\n    ss_e <- ss_t - ss_m\n    dig_free <- length(unique(dt_tmp[[c_c]]))-1\n    ms_e <- ss_e/(nrow(dt_tmp)-dig_free-1)\n    mat_nf[c_r, c_c] <- sqrt(max((ss_m - dig_free*ms_e)/ss_t, 0))\n  }\n}\ncorrplot(mat_nf[,setdiff(cols_factor, c('playerID'))],\n         is.corr = FALSE, #相関行列ではない場合 (数値の範囲が[-1, 1]固定ではなくなる)\n         col.lim = c(0, 1), #数値の範囲指定 \n         method = 'color', tl.cex = 0.8,\n         col = COL1('YlGn'),\n         cl.ratio = 0.4 #凡例の幅調節　そのままだと細すぎたので太目に変更\n         )\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in corrplot(mat_nf[, setdiff(cols_factor, c(\"playerID\"))], is.corr =\nFALSE, : col.lim interval too wide, please set a suitable value\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](corrplot_files/figure-html/corrplot6-1.png){width=576}\n:::\n:::\n\n\n\n\nまた別の例として、質的変数同士の組に対してはクラメールの連関係数を表示してみます。\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmat_ff <- matrix(nrow = length(cols_factor), ncol = length(cols_factor))\nrownames(mat_ff) <- cols_factor\ncolnames(mat_ff) <- cols_factor\n\ndt <- dt_mlb\nfor(c_r in cols_factor){\n  for(c_c in cols_factor){\n    #非常に小さいカテゴリがある場合は検定の仮定となる近似が満たされなくなるため、警告が表示される\n    suppressWarnings(mat_ff[c_r, c_c] <- lsr::cramersV(dt[[c_r]], dt[[c_c]]))\n  }\n}\ncorrplot(mat_ff[setdiff(cols_factor, c('playerID')), setdiff(cols_factor, c('playerID'))],\n         is.corr = FALSE, #相関行列ではない場合 (数値の範囲が[-1, 1]固定ではなくなる)\n         col.lim = c(0, 1), #数値の範囲指定 \n         method = 'color',\n         addgrid.col = 'white', #罫線を白色で表示する\n         tl.cex = 0.8, addCoef.col = 'black', number.cex = 0.65, \n         col = COL1('Blues'),\n         )\n```\n\n::: {.cell-output-display}\n![](corrplot_files/figure-html/corrplot7-1.png){width=576}\n:::\n:::\n\n\n\n\n\n## 参考\n\n- [An Introduction to corrplot Package](https://cran.r-project.org/web/packages/corrplot/vignettes/corrplot-intro.html)",
    "supporting": [
      "corrplot_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}